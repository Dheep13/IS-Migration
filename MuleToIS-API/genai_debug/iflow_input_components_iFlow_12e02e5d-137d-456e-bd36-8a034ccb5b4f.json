{
  "api_name": "Product API",
  "base_url": "http://localhost:8081/api/v1",
  "endpoints": [
    {
      "method": "GET",
      "path": "/products",
      "purpose": "Retrieves product details based on the provided product identifier",
      "components": [
        {
          "type": "odata",
          "name": "Get_Product_Details",
          "id": "odata_get_product",
          "config": {
            "address": "https://refapp-espm-ui-cf.cfapps.eu10.hana.ondemand.com:443",
            "resource_path": "/espm-cloud-web/espm.svc/Products",
            "operation": "Query(GET)",
            "query_options": "$filter=ProductId eq '${property.productIdentifier}'&$select=ProductId,Category,CategoryName,CurrencyCode,DimensionDepth,DimensionHeight,DimensionUnit,DimensionWidth,LongDescription,Name,PictureUrl,Price,QuantityUnit,ShortDescription,SupplierId,Weight,WeightUnit"
          }
        },
        {
          "type": "enricher",
          "name": "Validate_Product_ID",
          "id": "enricher_validate_product",
          "config": {
            "content": "var productidentifer = context.getProperty(\"odata.productIdentifiers\").split(\",\");\nvar productId = message.getHeaders().get(\"queryParams\").get(\"productIdentifier\");\nvar isValid = false;\n\nfor (var i = 0; i < productidentifer.length; i++) {\n  if (productidentifer[i] === productId) {\n    isValid = true;\n    break;\n  }\n}\n\ncontext.setProperty(\"isExistProduct\", isValid);"
          }
        },
        {
          "type": "groovy_script",
          "name": "Router_Product_Valid",
          "id": "script_router_product_valid",
          "config": {
            "script": "ProductValidRouter.groovy"
          }
        },
        {
          "type": "enricher",
          "name": "Format_Success_Response",
          "id": "enricher_format_success",
          "config": {
            "content": "// Pass through the OData response as JSON\nmessage.setHeader(\"Content-Type\", \"application/json\");"
          }
        },
        {
          "type": "enricher",
          "name": "Create_Error_Response",
          "id": "enricher_create_error",
          "config": {
            "content": "var productId = message.getHeaders().get(\"queryParams\").get(\"productIdentifier\");\nvar errorResponse = {\n  \"status\": \"error\",\n  \"message\": \"The product identifier \" + productId + \" was not found.\",\n  \"errorCode\": \"PRODUCT_NOT_FOUND\"\n};\n\nmessage.setBody(JSON.stringify(errorResponse));\nmessage.setHeader(\"Content-Type\", \"application/json\");\nmessage.setHeader(\"HTTP_RESPONSE_CODE\", \"404\");"
          }
        }
      ],
      "sequence": [
        "enricher_validate_product",
        "script_router_product_valid",
        "odata_get_product",
        "enricher_format_success"
      ],
      "transformations": [
        {
          "name": "ProductValidRouter.groovy",
          "type": "groovy",
          "script": "import com.sap.gateway.ip.core.customdev.util.Message;\n\ndef Message processData(Message message) {\n    def isExistProduct = message.getProperties().get(\"isExistProduct\");\n    \n    if (isExistProduct) {\n        // Log success\n        def productId = message.getHeaders().get(\"queryParams\").get(\"productIdentifier\");\n        println(\"The request is processed and sent downstream with the product identifier (\" + productId + \").\");\n        \n        // Store productIdentifier as property for OData query\n        message.setProperty(\"productIdentifier\", productId);\n        \n        // Route to success path (OData call)\n        message.setProperty(\"routeTo\", \"success\");\n    } else {\n        // Log error\n        def productId = message.getHeaders().get(\"queryParams\").get(\"productIdentifier\");\n        println(\"The product identifier (\" + productId + \") was not passed in the request or was passed incorrectly.\");\n        \n        // Route to error path\n        message.setProperty(\"routeTo\", \"error\");\n    }\n    \n    return message;\n}"
        }
      ],
      "sequence_flows": [
        {
          "id": "SequenceFlow_Start",
          "source": "odata_get_product",
          "target": "enricher_validate_product",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_Start\" sourceRef=\"odata_get_product\" targetRef=\"enricher_validate_product\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_1",
          "source": "enricher_validate_product",
          "target": "script_router_product_valid",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_1\" sourceRef=\"enricher_validate_product\" targetRef=\"script_router_product_valid\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_2",
          "source": "script_router_product_valid",
          "target": "enricher_format_success",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_2\" sourceRef=\"script_router_product_valid\" targetRef=\"enricher_format_success\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_End",
          "source": "enricher_format_success",
          "target": "enricher_create_error",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_End\" sourceRef=\"enricher_format_success\" targetRef=\"enricher_create_error\" isImmediate=\"true\"/>"
        }
      ]
    }
  ]
}