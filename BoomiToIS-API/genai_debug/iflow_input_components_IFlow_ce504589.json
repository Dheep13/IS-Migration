{
  "process_name": "Stripe to Salesforce Opportunity Integration",
  "description": "This integration creates Salesforce Opportunities automatically when new subscriptions are created in Stripe. It listens for Stripe webhook events, enriches the data with customer and product information, and creates corresponding Opportunity records in Salesforce.",
  "endpoints": [
    {
      "method": "POST",
      "path": "/webhook/stripe/subscription",
      "purpose": "Receives subscription events from Stripe and creates Salesforce Opportunities",
      "components": [
        {
          "type": "enricher",
          "name": "Extract_Subscription_Data",
          "id": "enricher_extract_subscription",
          "config": {
            "content": "Extracts customer_id and product_id from the Stripe webhook payload"
          }
        },
        {
          "type": "enricher",
          "name": "Set_Opportunity_Description",
          "id": "enricher_description",
          "config": {
            "content": "${property.CustomerName} has subscribed to: ${property.ProductName}"
          }
        },
        {
          "type": "enricher",
          "name": "Calculate_Close_Date",
          "id": "enricher_close_date",
          "config": {
            "content": "Sets CloseDate to 3 months from current date"
          }
        },
        {
          "type": "groovy_script",
          "name": "Map_To_Opportunity",
          "id": "script_map_opportunity",
          "config": {
            "script": "MapToOpportunity.groovy"
          }
        },
        {
          "type": "request_reply",
          "name": "Get_Customer_Info",
          "id": "request_reply_customer",
          "config": {
            "endpoint_path": "/v1/customers/${property.customer_id}",
            "address": "https://api.stripe.com"
          }
        },
        {
          "type": "request_reply",
          "name": "Get_Product_Info",
          "id": "request_reply_product",
          "config": {
            "endpoint_path": "/v1/products/${property.product_id}",
            "address": "https://api.stripe.com"
          }
        },
        {
          "type": "request_reply",
          "name": "Create_Salesforce_Opportunity",
          "id": "request_reply_salesforce",
          "config": {
            "endpoint_path": "/services/data/v52.0/sobjects/Opportunity",
            "address": "https://${property.salesforce_instance}.salesforce.com"
          }
        }
      ],
      "error_handling": {
        "exception_subprocess": [
          {
            "type": "enricher",
            "name": "Set_Error_Message",
            "id": "error_message",
            "trigger": "any_error",
            "config": {
              "content": "Error occurred during Stripe to Salesforce integration: ${property.error}"
            }
          },
          {
            "type": "request_reply",
            "name": "Send_Error_Notification",
            "id": "error_notification",
            "trigger": "any_error",
            "config": {
              "endpoint_path": "/api/notifications/email"
            }
          }
        ]
      },
      "branching": {
        "type": "exclusive",
        "branches": [
          {
            "condition": "event.type == 'customer.subscription.created'",
            "components": [
              "enricher_extract_subscription",
              "request_reply_customer",
              "request_reply_product",
              "enricher_description",
              "enricher_close_date",
              "script_map_opportunity",
              "request_reply_salesforce"
            ],
            "sequence": [
              "enricher_extract_subscription",
              "request_reply_customer",
              "request_reply_product",
              "enricher_description",
              "enricher_close_date",
              "script_map_opportunity",
              "request_reply_salesforce"
            ]
          }
        ]
      },
      "sequence": [
        "enricher_extract_subscription",
        "request_reply_customer",
        "request_reply_product",
        "enricher_description",
        "enricher_close_date",
        "script_map_opportunity",
        "request_reply_salesforce"
      ],
      "transformations": [
        {
          "name": "MapToOpportunity.groovy",
          "type": "groovy",
          "script": "import groovy.json.*\n\ndef jsonSlurper = new JsonSlurper()\ndef body = message.getBody(String.class)\ndef payload = jsonSlurper.parseText(body)\n\ndef opportunityData = [\n    \"Name\": property.get(\"CustomerName\"),\n    \"Description\": property.get(\"SalesforceDescription\"),\n    \"CloseDate\": property.get(\"CloseDate\"),\n    \"StageName\": \"Prospecting\"\n]\n\nmessage.setBody(JsonOutput.toJson(opportunityData))\nreturn message"
        }
      ],
      "sequence_flows": [
        {
          "id": "SequenceFlow_Start",
          "source": "enricher_extract_subscription",
          "target": "enricher_description",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_Start\" sourceRef=\"enricher_extract_subscription\" targetRef=\"enricher_description\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_1",
          "source": "enricher_description",
          "target": "enricher_close_date",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_1\" sourceRef=\"enricher_description\" targetRef=\"enricher_close_date\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_2",
          "source": "enricher_close_date",
          "target": "script_map_opportunity",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_2\" sourceRef=\"enricher_close_date\" targetRef=\"script_map_opportunity\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_3",
          "source": "script_map_opportunity",
          "target": "request_reply_customer",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_3\" sourceRef=\"script_map_opportunity\" targetRef=\"request_reply_customer\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_4",
          "source": "request_reply_customer",
          "target": "request_reply_product",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_4\" sourceRef=\"request_reply_customer\" targetRef=\"request_reply_product\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_End",
          "source": "request_reply_product",
          "target": "request_reply_salesforce",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_End\" sourceRef=\"request_reply_product\" targetRef=\"request_reply_salesforce\" isImmediate=\"true\"/>"
        }
      ]
    }
  ]
}