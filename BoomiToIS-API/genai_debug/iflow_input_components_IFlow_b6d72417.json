{
  "process_name": "Create Salesforce Opportunities from Stripe Subscriptions",
  "description": "This integration creates Salesforce Opportunities automatically when new Stripe subscriptions are created. It listens for Stripe subscription events, enriches the data by retrieving customer and product details, and then creates a corresponding Opportunity record in Salesforce.",
  "endpoints": [
    {
      "method": "POST",
      "path": "/webhook/stripe/subscription",
      "purpose": "Receives subscription events from Stripe and creates Salesforce Opportunities",
      "components": [
        {
          "type": "enricher",
          "name": "Set_Salesforce_Description",
          "id": "set_sf_description",
          "config": {
            "content": "${property.CustomerName} has subscribed to: ${property.Subscription}"
          }
        },
        {
          "type": "message_mapping",
          "name": "Map_To_Salesforce_Opportunity",
          "id": "map_to_opportunity",
          "config": {}
        },
        {
          "type": "groovy_script",
          "name": "Calculate_Close_Date",
          "id": "calculate_close_date",
          "config": {
            "script": "CalculateCloseDate.groovy"
          }
        },
        {
          "type": "request_reply",
          "name": "Get_Stripe_Customer_Info",
          "id": "get_customer_info",
          "config": {
            "endpoint_path": "/v1/customers/{customer_id}",
            "address": "https://api.stripe.com"
          }
        },
        {
          "type": "request_reply",
          "name": "Get_Stripe_Product_Info",
          "id": "get_product_info",
          "config": {
            "endpoint_path": "/v1/products/{product_id}",
            "address": "https://api.stripe.com"
          }
        },
        {
          "type": "request_reply",
          "name": "Create_Salesforce_Opportunity",
          "id": "create_opportunity",
          "config": {
            "endpoint_path": "/services/data/v52.0/sobjects/Opportunity",
            "address": "https://salesforce.com"
          }
        }
      ],
      "error_handling": {
        "exception_subprocess": [
          {
            "type": "enricher",
            "name": "Set_Error_Message",
            "id": "set_error_message",
            "trigger": "any_error",
            "config": {
              "content": "Error occurred during Stripe to Salesforce integration: ${property.error}"
            }
          },
          {
            "type": "groovy_script",
            "name": "Log_Error_Details",
            "id": "log_error_details",
            "trigger": "any_error",
            "config": {
              "script": "LogErrorDetails.groovy"
            }
          }
        ]
      },
      "branching": {
        "type": "exclusive",
        "branches": [
          {
            "condition": "Default path",
            "components": [
              "get_customer_info",
              "get_product_info",
              "set_sf_description",
              "calculate_close_date",
              "map_to_opportunity",
              "create_opportunity"
            ],
            "sequence": [
              "get_customer_info",
              "get_product_info",
              "set_sf_description",
              "calculate_close_date",
              "map_to_opportunity",
              "create_opportunity"
            ]
          }
        ]
      },
      "sequence": [
        "get_customer_info",
        "get_product_info",
        "set_sf_description",
        "calculate_close_date",
        "map_to_opportunity",
        "create_opportunity"
      ],
      "transformations": [
        {
          "name": "CalculateCloseDate.groovy",
          "type": "groovy",
          "script": "import java.time.LocalDate\nimport java.time.format.DateTimeFormatter\n\nLocalDate currentDate = LocalDate.now()\nLocalDate closeDate = currentDate.minusMonths(3)\nDateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyy-MM-dd\")\nreturn closeDate.format(formatter)"
        },
        {
          "name": "LogErrorDetails.groovy",
          "type": "groovy",
          "script": "import java.time.LocalDateTime\n\ndef errorMsg = message.getProperty(\"error\")\ndef timestamp = LocalDateTime.now()\n\nlogger.addAttachmentAsString(\"error_log\", \"${timestamp}: ${errorMsg}\", \"text/plain\")\n\nreturn message"
        }
      ],
      "sequence_flows": [
        {
          "id": "SequenceFlow_Start",
          "source": "set_sf_description",
          "target": "map_to_opportunity",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_Start\" sourceRef=\"set_sf_description\" targetRef=\"map_to_opportunity\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_1",
          "source": "map_to_opportunity",
          "target": "calculate_close_date",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_1\" sourceRef=\"map_to_opportunity\" targetRef=\"calculate_close_date\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_2",
          "source": "calculate_close_date",
          "target": "get_customer_info",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_2\" sourceRef=\"calculate_close_date\" targetRef=\"get_customer_info\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_3",
          "source": "get_customer_info",
          "target": "get_product_info",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_3\" sourceRef=\"get_customer_info\" targetRef=\"get_product_info\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_End",
          "source": "get_product_info",
          "target": "create_opportunity",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_End\" sourceRef=\"get_product_info\" targetRef=\"create_opportunity\" isImmediate=\"true\"/>"
        }
      ]
    }
  ]
}