{
  "process_name": "Create Salesforce Opportunities from Stripe Subscriptions",
  "description": "This integration creates Salesforce Opportunities based on Stripe Subscription data. It retrieves customer and product information from Stripe APIs and uses this data to create opportunities in Salesforce.",
  "endpoints": [
    {
      "method": "GET",
      "path": "/stripe-to-salesforce/opportunities",
      "purpose": "Create Salesforce Opportunities from Stripe Subscriptions",
      "components": [
        {
          "type": "enricher",
          "name": "Set_Initial_Properties",
          "id": "enricher_initial_props",
          "config": {
            "content": "Set initial properties needed for the integration"
          }
        },
        {
          "type": "enricher",
          "name": "Build_Description_String",
          "id": "enricher_description",
          "config": {
            "content": "Create Salesforce opportunity description by concatenating DDP_CustomerName + 'has subscribed to: ' + DDP_Subscription"
          }
        },
        {
          "type": "groovy_script",
          "name": "Calculate_Close_Date",
          "id": "script_close_date",
          "config": {
            "script": "import java.time.LocalDate\nimport java.time.format.DateTimeFormatter\n\nLocalDate currentDate = LocalDate.now()\nLocalDate closeDate = currentDate.minusMonths(3)\nDateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyy-MM-dd\")\n\nreturn closeDate.format(formatter)"
          }
        },
        {
          "type": "groovy_script",
          "name": "Map_To_Salesforce_Opportunity",
          "id": "transform_to_opportunity",
          "config": {
            "script": "def opportunity = [:]\nopportunity.Name = message.properties.DDP_CustomerName + ' - ' + message.properties.DDP_Subscription\nopportunity.Description = message.properties.DDP_SalesforceDescription\nopportunity.CloseDate = message.properties.DDP_CloseDate\nopportunity.StageName = 'Closed Won'\nopportunity.Amount = message.body.amount\n\nreturn opportunity"
          }
        },
        {
          "type": "request_reply",
          "name": "Get_Stripe_Customer",
          "id": "request_reply_stripe_customer",
          "receiver_adapter": {
            "type": "http_adapter",
            "operation": "GET",
            "endpoint": "/customers/{customer_id}",
            "connection": "stripe_api_connection"
          },
          "config": {
            "endpoint_path": "/customers/{customer_id}",
            "method": "GET",
            "address": "https://api.stripe.com/v1"
          }
        },
        {
          "type": "request_reply",
          "name": "Get_Stripe_Product",
          "id": "request_reply_stripe_product",
          "receiver_adapter": {
            "type": "http_adapter",
            "operation": "GET",
            "endpoint": "/products/{product_id}",
            "connection": "stripe_api_connection"
          },
          "config": {
            "endpoint_path": "/products/{product_id}",
            "method": "GET",
            "address": "https://api.stripe.com/v1"
          }
        },
        {
          "type": "request_reply",
          "name": "Create_Salesforce_Opportunity",
          "id": "request_reply_salesforce",
          "receiver_adapter": {
            "type": "odata_adapter",
            "operation": "POST",
            "endpoint": "/services/data/v53.0/sobjects/Opportunity",
            "connection": "salesforce_odata_connection"
          },
          "config": {
            "endpoint_path": "/services/data/v53.0/sobjects/Opportunity",
            "method": "POST",
            "address": "https://{instance}.salesforce.com",
            "resource_path": "Opportunity"
          }
        },
        {
          "type": "enricher",
          "name": "Process_Customer_Response",
          "id": "enricher_customer_response",
          "config": {
            "content": "Extract customer name from the API response and set DDP_CustomerName property"
          }
        },
        {
          "type": "enricher",
          "name": "Process_Product_Response",
          "id": "enricher_product_response",
          "config": {
            "content": "Extract product name from the API response and set DDP_Subscription property"
          }
        }
      ],
      "error_handling": {
        "exception_subprocess": [
          {
            "type": "enricher",
            "name": "Set_Error_Message",
            "id": "error_message",
            "trigger": "any_error",
            "config": {
              "content": "Set error details for logging and notification"
            }
          },
          {
            "type": "request_reply",
            "name": "Send_Error_Notification",
            "id": "error_notification",
            "trigger": "any_error",
            "receiver_adapter": {
              "type": "http_adapter",
              "operation": "POST",
              "endpoint": "/api/notifications",
              "connection": "notification_service"
            },
            "config": {
              "endpoint_path": "/api/notifications",
              "method": "POST"
            }
          }
        ]
      },
      "branching": {
        "type": "exclusive",
        "branches": [
          {
            "condition": "Default path",
            "components": [
              "enricher_initial_props",
              "request_reply_stripe_customer",
              "enricher_customer_response",
              "request_reply_stripe_product",
              "enricher_product_response",
              "enricher_description",
              "script_close_date",
              "transform_to_opportunity",
              "request_reply_salesforce"
            ],
            "sequence": [
              "enricher_initial_props",
              "request_reply_stripe_customer",
              "enricher_customer_response",
              "request_reply_stripe_product",
              "enricher_product_response",
              "enricher_description",
              "script_close_date",
              "transform_to_opportunity",
              "request_reply_salesforce"
            ]
          }
        ]
      },
      "sequence": [
        "enricher_initial_props",
        "request_reply_stripe_customer",
        "enricher_customer_response",
        "request_reply_stripe_product",
        "enricher_product_response",
        "enricher_description",
        "script_close_date",
        "transform_to_opportunity",
        "request_reply_salesforce"
      ],
      "transformations": [
        {
          "name": "CalculateCloseDate.groovy",
          "type": "groovy",
          "script": "import java.time.LocalDate\nimport java.time.format.DateTimeFormatter\n\nLocalDate currentDate = LocalDate.now()\nLocalDate closeDate = currentDate.minusMonths(3)\nDateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyy-MM-dd\")\n\nreturn closeDate.format(formatter)"
        },
        {
          "name": "MapToSalesforceOpportunity.groovy",
          "type": "groovy",
          "script": "def opportunity = [:]\nopportunity.Name = message.properties.DDP_CustomerName + ' - ' + message.properties.DDP_Subscription\nopportunity.Description = message.properties.DDP_SalesforceDescription\nopportunity.CloseDate = message.properties.DDP_CloseDate\nopportunity.StageName = 'Closed Won'\nopportunity.Amount = message.body.amount\n\nreturn opportunity"
        }
      ],
      "sequence_flows": [
        {
          "id": "SequenceFlow_Start",
          "source": "enricher_initial_props",
          "target": "enricher_description",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_Start\" sourceRef=\"enricher_initial_props\" targetRef=\"enricher_description\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_1",
          "source": "enricher_description",
          "target": "script_close_date",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_1\" sourceRef=\"enricher_description\" targetRef=\"script_close_date\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_2",
          "source": "script_close_date",
          "target": "transform_to_opportunity",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_2\" sourceRef=\"script_close_date\" targetRef=\"transform_to_opportunity\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_3",
          "source": "transform_to_opportunity",
          "target": "request_reply_stripe_customer",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_3\" sourceRef=\"transform_to_opportunity\" targetRef=\"request_reply_stripe_customer\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_4",
          "source": "request_reply_stripe_customer",
          "target": "request_reply_stripe_product",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_4\" sourceRef=\"request_reply_stripe_customer\" targetRef=\"request_reply_stripe_product\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_5",
          "source": "request_reply_stripe_product",
          "target": "request_reply_salesforce",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_5\" sourceRef=\"request_reply_stripe_product\" targetRef=\"request_reply_salesforce\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_6",
          "source": "request_reply_salesforce",
          "target": "enricher_customer_response",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_6\" sourceRef=\"request_reply_salesforce\" targetRef=\"enricher_customer_response\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_End",
          "source": "enricher_customer_response",
          "target": "enricher_product_response",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_End\" sourceRef=\"enricher_customer_response\" targetRef=\"enricher_product_response\" isImmediate=\"true\"/>"
        }
      ]
    }
  ]
}