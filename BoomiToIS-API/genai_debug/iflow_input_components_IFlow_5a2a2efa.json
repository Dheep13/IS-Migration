{
  "process_name": "Stripe to Salesforce Opportunity Integration",
  "description": "This integration creates Salesforce Opportunities automatically when Stripe Subscriptions are completed. It listens for Stripe webhook events, transforms subscription data into Salesforce Opportunity format, and creates new records in Salesforce.",
  "endpoints": [
    {
      "method": "POST",
      "path": "/webhook/stripe/subscription",
      "purpose": "Receives webhook notifications from Stripe when subscription events occur",
      "components": [
        {
          "type": "enricher",
          "name": "Extract_Stripe_Subscription_Properties",
          "id": "enricher_stripe_properties",
          "config": {
            "content": "subscription_id = ${body.data.object.id};\ncustomer_id = ${body.data.object.customer};\nsubscription_name = ${body.data.object.items.data[0].price.nickname};\nsubscription_date = ${body.created};\nsubscription_amount = ${body.data.object.items.data[0].price.unit_amount / 100};"
          }
        },
        {
          "type": "request_reply",
          "name": "Create_Salesforce_Opportunity",
          "id": "salesforce_create_opportunity",
          "config": {
            "endpoint_path": "/services/data/v53.0/sobjects/Opportunity",
            "method": "POST",
            "address": "https://yourinstance.salesforce.com"
          }
        },
        {
          "type": "groovy_script",
          "name": "Transform_Stripe_To_Salesforce",
          "id": "transform_stripe_to_sf",
          "config": {
            "script": "TransformStripeToSalesforce.groovy"
          }
        }
      ],
      "sequence": [
        "enricher_stripe_properties",
        "transform_stripe_to_sf",
        "salesforce_create_opportunity"
      ],
      "transformations": [
        {
          "name": "TransformStripeToSalesforce.groovy",
          "type": "groovy",
          "script": "import groovy.xml.*\n\ndef jsonData = message.getBody(java.lang.String)\ndef jsonSlurper = new groovy.json.JsonSlurper()\ndef stripeEvent = jsonSlurper.parseText(jsonData)\n\n// Extract subscription data\ndef subscription = stripeEvent.data.object\ndef subscriptionName = subscription.items.data[0].price.nickname ?: \"Subscription \" + subscription.id\ndef closeDate = new Date(stripeEvent.created * 1000).format(\"yyyy-MM-dd\")\ndef description = \"Stripe Subscription: \" + subscription.id + \" for customer: \" + subscription.customer\n\n// Create Salesforce Opportunity XML\ndef writer = new StringWriter()\ndef builder = new MarkupBuilder(writer)\n\nbuilder.Opportunity {\n    Name(subscriptionName)\n    CloseDate(closeDate)\n    StageName(\"Closed Won\")\n    Description(description)\n    Amount(subscription.items.data[0].price.unit_amount ? subscription.items.data[0].price.unit_amount / 100 : 0)\n}\n\n// Set the output as the message body\nmessage.setBody(writer.toString())\n\n// Set content type header for Salesforce\nmessage.setHeader(\"Content-Type\", \"application/xml\")\n\nreturn message"
        }
      ],
      "sequence_flows": [
        {
          "id": "SequenceFlow_Start",
          "source": "enricher_stripe_properties",
          "target": "salesforce_create_opportunity",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_Start\" sourceRef=\"enricher_stripe_properties\" targetRef=\"salesforce_create_opportunity\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_End",
          "source": "salesforce_create_opportunity",
          "target": "transform_stripe_to_sf",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_End\" sourceRef=\"salesforce_create_opportunity\" targetRef=\"transform_stripe_to_sf\" isImmediate=\"true\"/>"
        }
      ]
    }
  ]
}