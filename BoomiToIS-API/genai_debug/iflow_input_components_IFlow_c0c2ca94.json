{
  "process_name": "Stripe to Salesforce Opportunity Integration",
  "description": "This integration creates Salesforce Opportunities from Stripe Subscriptions. When a customer subscribes to a product in Stripe, the integration retrieves customer and product details from Stripe APIs, transforms the data, and creates a corresponding Opportunity record in Salesforce.",
  "endpoints": [
    {
      "method": "GET",
      "path": "/stripe-to-salesforce-opportunity",
      "purpose": "Create Salesforce Opportunities from Stripe Subscriptions",
      "components": [
        {
          "type": "enricher",
          "name": "Set_Salesforce_Description",
          "id": "set_description",
          "config": {
            "content": "${get_customer_info.response.name} has subscribed to: ${get_product_info.response.name}"
          }
        },
        {
          "type": "enricher",
          "name": "Calculate_Close_Date",
          "id": "set_close_date",
          "config": {
            "content": "${date:now():minusDays(90):format('yyyy-MM-dd')}"
          }
        },
        {
          "type": "groovy_script",
          "name": "Map_To_Salesforce_Opportunity",
          "id": "map_to_opportunity",
          "config": {
            "script": "MapToSalesforceOpportunity.groovy"
          }
        },
        {
          "type": "request_reply",
          "name": "Get_Stripe_Customer_Info",
          "id": "get_customer_info",
          "receiver_adapter": {
            "type": "http_adapter",
            "operation": "GET",
            "endpoint": "/v1/customers/{customer_id}",
            "connection": "stripe_api_connection"
          },
          "config": {
            "endpoint_path": "/v1/customers/{customer_id}",
            "method": "GET",
            "address": "https://api.stripe.com/v1",
            "resource_path": "customers/{customer_id}"
          }
        },
        {
          "type": "request_reply",
          "name": "Get_Stripe_Product_Info",
          "id": "get_product_info",
          "receiver_adapter": {
            "type": "http_adapter",
            "operation": "GET",
            "endpoint": "/v1/products/{product_id}",
            "connection": "stripe_api_connection"
          },
          "config": {
            "endpoint_path": "/v1/products/{product_id}",
            "method": "GET",
            "address": "https://api.stripe.com/v1",
            "resource_path": "products/{product_id}"
          }
        },
        {
          "type": "request_reply",
          "name": "Create_Salesforce_Opportunity",
          "id": "create_opportunity",
          "receiver_adapter": {
            "type": "odata_adapter",
            "operation": "POST",
            "endpoint": "/services/data/v52.0/sobjects/Opportunity",
            "connection": "salesforce_odata_connection"
          },
          "config": {
            "endpoint_path": "/services/data/v52.0/sobjects/Opportunity",
            "method": "POST",
            "address": "https://{instance}.salesforce.com",
            "resource_path": "services/data/v52.0/sobjects/Opportunity"
          }
        }
      ],
      "error_handling": {
        "exception_subprocess": [
          {
            "type": "enricher",
            "name": "Set_Error_Message",
            "id": "set_error_message",
            "trigger": "any_error",
            "config": {
              "content": "Error occurred during Stripe to Salesforce integration: ${exception.message}"
            }
          },
          {
            "type": "groovy_script",
            "name": "Log_Error_Details",
            "id": "log_error_details",
            "trigger": "any_error",
            "config": {
              "script": "LogErrorDetails.groovy"
            }
          }
        ]
      },
      "sequence": [
        "get_customer_info",
        "get_product_info",
        "set_description",
        "set_close_date",
        "map_to_opportunity",
        "create_opportunity"
      ],
      "transformations": [
        {
          "name": "MapToSalesforceOpportunity.groovy",
          "type": "groovy",
          "script": "import groovy.json.*\n\ndef jsonSlurper = new JsonSlurper()\ndef customerData = jsonSlurper.parseText(message.getBody(String.class))\n\ndef opportunityData = [\n    'Name': customerData.product_name,\n    'Description': message.getProperty('SalesforceDescription'),\n    'CloseDate': message.getProperty('CloseDate'),\n    'StageName': 'Closed Won',\n    'Amount': customerData.subscription_amount,\n    'AccountId': customerData.account_id\n]\n\nmessage.setBody(JsonOutput.toJson(opportunityData))\nreturn message"
        },
        {
          "name": "LogErrorDetails.groovy",
          "type": "groovy",
          "script": "import groovy.json.*\n\ndef errorDetails = [\n    'timestamp': new Date().format(\"yyyy-MM-dd'T'HH:mm:ss.SSSZ\"),\n    'process': 'Stripe to Salesforce Opportunity Integration',\n    'error_message': message.getProperty('ErrorMessage'),\n    'error_type': message.getProperty('exception.type'),\n    'error_details': message.getProperty('exception.message')\n]\n\nmessage.setBody(JsonOutput.toJson(errorDetails))\nreturn message"
        }
      ],
      "sequence_flows": [
        {
          "id": "SequenceFlow_Start",
          "source": "set_description",
          "target": "set_close_date",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_Start\" sourceRef=\"set_description\" targetRef=\"set_close_date\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_1",
          "source": "set_close_date",
          "target": "map_to_opportunity",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_1\" sourceRef=\"set_close_date\" targetRef=\"map_to_opportunity\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_2",
          "source": "map_to_opportunity",
          "target": "get_customer_info",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_2\" sourceRef=\"map_to_opportunity\" targetRef=\"get_customer_info\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_3",
          "source": "get_customer_info",
          "target": "get_product_info",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_3\" sourceRef=\"get_customer_info\" targetRef=\"get_product_info\" isImmediate=\"true\"/>"
        },
        {
          "id": "SequenceFlow_End",
          "source": "get_product_info",
          "target": "create_opportunity",
          "is_immediate": true,
          "xml_content": "<bpmn2:sequenceFlow id=\"SequenceFlow_End\" sourceRef=\"get_product_info\" targetRef=\"create_opportunity\" isImmediate=\"true\"/>"
        }
      ]
    }
  ]
}